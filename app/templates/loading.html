{% extends "base.html" %} {% block content %}
<div id="loading-screen" class="screen active">
    <div class="loading-container">
        <div class="spinner"></div>
        <p data-i18n="generating-puzzle">Generating puzzle...</p>
        <small data-i18n="generating-subtitle">This may take a moment</small>
    </div>
</div>

<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        min-height: 60vh;
    }

    .spinner {
        border: 4px solid var(--color-grid-border);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .loading-container p {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .loading-container small {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
    }
</style>

<script>
    // Get difficulty from sessionStorage or default to 'easy'
    const difficulty = sessionStorage.getItem("difficulty") || "easy";

    // Generate puzzle on loading page
    async function generateAndRedirect() {
        try {
            const generateResponse = await fetch("/api/generate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ difficulty: difficulty }),
            });

            if (!generateResponse.ok) {
                throw new Error("Failed to generate puzzle");
            }

            const generateData = await generateResponse.json();
            console.log("Puzzle generated successfully:", generateData);

            // Save puzzle and solution to sessionStorage
            sessionStorage.setItem("puzzle", generateData.puzzle);
            sessionStorage.setItem("difficulty", difficulty);

            // Solve the puzzle to get the solution
            const solveResponse = await fetch("/api/solve", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ board: generateData.puzzle }),
            });

            if (!solveResponse.ok) {
                throw new Error("Failed to solve puzzle");
            }

            const solveData = await solveResponse.json();
            sessionStorage.setItem("solution", solveData.solution);
            sessionStorage.setItem("timestamp", Date.now());

            // Redirect to game
            window.location.href = "/game";
        } catch (error) {
            console.error("Error generating puzzle:", error);
            alert("Error generating puzzle. Please try again.");
            window.location.href = "/";
        }
    }

    // Start generation when page loads
    generateAndRedirect();
</script>
{% endblock %}
